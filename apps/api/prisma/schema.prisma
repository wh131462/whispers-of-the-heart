// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户模型 - 简化版
model User {
  id            String   @id @default(cuid())
  username      String   @unique
  email         String   @unique
  password      String
  avatar        String?
  bio           String?
  location      String?  // 最后一次 IP 归属地
  isAdmin       Boolean  @default(false) // 简化权限：仅区分管理员和普通用户
  emailVerified Boolean  @default(false) // 邮箱是否已验证
  theme         String?  @default("system") // 主题偏好：system, light, dark
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 邮件通知偏好
  emailNotifications Boolean @default(true)  // 是否接收邮件通知
  notifyOnComment    Boolean @default(true)  // 有人评论我的文章时通知
  notifyOnReply      Boolean @default(true)  // 有人回复我的评论时通知

  // 关联关系
  posts               Post[]
  comments            Comment[]
  likes               Like[]
  commentLikes        CommentLike[]
  favorites           Favorite[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  verificationCodes   VerificationCode[]
  media               Media[]
  commentReports      CommentReport[]
  repliedToComments   Comment[]            @relation("CommentReplyToUser") // 被回复的评论

  @@index([email])
  @@index([username])
  @@map("users")
}

// 刷新令牌模型
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// 密码重置令牌模型
model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// 验证码模型 - 用于邮箱验证和邮箱更换
model VerificationCode {
  id        String   @id @default(cuid())
  code      String   // 6位数字验证码
  type      String   // 'register' | 'email_change'
  email     String   // 目标邮箱
  userId    String?  // 用户ID (注册时可能为空)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([code])
  @@index([expiresAt])
  @@map("verification_codes")
}

// 文章模型 - 简化版
model Post {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text
  excerpt     String?
  slug        String    @unique
  coverImage  String?
  published   Boolean   @default(false) // 简化：仅区分草稿和已发布
  publishedAt DateTime?
  views       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 关联关系
  authorId      String
  author        User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  postTags      PostTag[]
  postComments  Comment[]
  postLikes     Like[]
  postFavorites Favorite[]

  @@index([slug])
  @@index([published])
  @@index([authorId])
  @@index([publishedAt])
  @@map("posts")
}

// 标签模型
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  postTags PostTag[]

  @@index([slug])
  @@map("tags")
}

// 文章标签关联表
model PostTag {
  id     String @id @default(cuid())
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
  @@map("post_tags")
}

// 评论模型 - 抖音风格扁平化结构
model Comment {
  id         String    @id @default(cuid())
  content    String
  isApproved Boolean   @default(false)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // 增强功能字段
  deletedAt  DateTime?  // 软删除时间
  editedAt   DateTime?  // 最后编辑时间
  isPinned   Boolean   @default(false) // 是否置顶

  // 文章关联
  postId       String
  post         Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId     String
  author       User            @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // 旧字段（保留用于数据迁移，之后可移除）
  parentId      String?
  parent        Comment?        @relation("CommentRepliesOld", fields: [parentId], references: [id], onDelete: Cascade)
  oldReplies    Comment[]       @relation("CommentRepliesOld")

  // 抖音风格评论结构：
  // rootId: 顶级评论ID，顶级评论为 null，回复指向顶级评论
  // replyToId: 被回复的评论ID（可以是顶级评论或其他回复）
  // replyToUserId: 被回复用户ID（冗余存储，方便显示 @用户名）
  rootId        String?
  root          Comment?        @relation("CommentRoot", fields: [rootId], references: [id], onDelete: Cascade)
  replies       Comment[]       @relation("CommentRoot")

  replyToId     String?
  replyTo       Comment?        @relation("CommentReplyTo", fields: [replyToId], references: [id], onDelete: SetNull)
  repliedBy     Comment[]       @relation("CommentReplyTo")

  replyToUserId String?
  replyToUser   User?           @relation("CommentReplyToUser", fields: [replyToUserId], references: [id], onDelete: SetNull)

  commentLikes CommentLike[]
  reports      CommentReport[]

  @@index([postId])
  @@index([authorId])
  @@index([rootId])
  @@index([replyToId])
  @@index([isApproved])
  @@index([deletedAt])
  @@index([isPinned])
  @@map("comments")
}

// 评论举报模型
model CommentReport {
  id        String   @id @default(cuid())
  reason    String   // spam, abuse, harassment, other
  details   String?  // 举报详情
  status    String   @default("pending") // pending, resolved, dismissed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  commentId  String
  comment    Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User    @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@unique([commentId, reporterId]) // 每个用户只能举报一次同一评论
  @@index([commentId])
  @@index([reporterId])
  @@index([status])
  @@map("comment_reports")
}

// 点赞模型
model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 关联关系
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("likes")
}

// 评论点赞模型
model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 关联关系
  commentId String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
  @@map("comment_likes")
}

// 收藏模型
model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 关联关系
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("favorites")
}

// 媒体库模型 - 简化的文件管理
model Media {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  thumbnail    String?
  hash         String?  @unique // 文件内容哈希，用于去重
  tags         String[] @default([]) // 用于分类和搜索
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关联关系
  uploaderId String
  uploader   User         @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  usages     MediaUsage[]

  @@index([mimeType])
  @@index([uploaderId])
  @@index([createdAt])
  @@index([url])
  @@index([hash])
  @@map("media")
}

// 媒体使用记录 - 追踪媒体在各处的引用
model MediaUsage {
  id        String   @id @default(cuid())
  mediaId   String
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  // 使用位置（多态关联）
  entityType String // 'post' | 'user' | 'site_config'
  entityId   String // 关联实体的 ID
  fieldName  String // 'avatar' | 'coverImage' | 'content'

  createdAt DateTime @default(now())

  @@unique([mediaId, entityType, entityId, fieldName])
  @@index([entityType, entityId])
  @@index([mediaId])
  @@map("media_usages")
}

// 站点配置模型 - 简化版
model SiteConfig {
  id              String   @id @default("default")
  siteName        String   @default("Whispers of the Heart")
  siteDescription String?
  siteLogo        String?  // 网站 Logo（用于导航栏左上角）
  ownerName       String?  // 博主名称（用于首页 Banner）
  ownerAvatar     String?  // 博主头像（用于首页 Banner）
  contactEmail    String?  // 联系邮箱
  socialLinks     Json?    // { github: "", twitter: "", linkedin: "" }
  commentSettings Json?    // { autoModeration: true, bannedWords: [] }
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("site_config")
}

// 邮件发送记录模型
model MailLog {
  id        String   @id @default(cuid())
  to        String   // 收件人邮箱
  subject   String   // 邮件主题
  template  String?  // 使用的模板名称
  context   Json?    // 模板上下文数据
  status    String   @default("pending") // pending, sent, failed
  error     String?  // 失败时的错误信息
  sentAt    DateTime? // 实际发送时间
  createdAt DateTime @default(now())

  @@index([to])
  @@index([status])
  @@index([template])
  @@index([createdAt])
  @@map("mail_logs")
}
