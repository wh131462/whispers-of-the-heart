# Docker åŸºç¡€è®¾æ–½é…ç½®

æœ¬é¡¹ç›®ä½¿ç”¨ Docker å’Œ Docker Compose æ¥ç®¡ç†æ•´ä¸ªåº”ç”¨æ ˆï¼ŒåŒ…æ‹¬å‰ç«¯ã€åç«¯ã€æ•°æ®åº“å’Œç¼“å­˜æœåŠ¡ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx Proxy   â”‚    â”‚   Frontend      â”‚    â”‚   Backend API   â”‚
â”‚   (Port 8080)   â”‚â—„â”€â”€â–ºâ”‚   (Port 80)     â”‚â—„â”€â”€â–ºâ”‚   (Port 7777)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚     Redis       â”‚    â”‚     MinIO       â”‚
â”‚   (Port 5432)   â”‚    â”‚   (Port 6379)   â”‚    â”‚  (Port 9000)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker 20.10+
- Docker Compose 2.0+
- è‡³å°‘ 4GB å¯ç”¨å†…å­˜
- è‡³å°‘ 10GB å¯ç”¨ç£ç›˜ç©ºé—´

### å¯åŠ¨åº”ç”¨

1. **å…‹éš†é¡¹ç›®å¹¶è¿›å…¥ç›®å½•**
   ```bash
   cd infra/docker
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   cp .env.example .env
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡
   ```

3. **å¯åŠ¨æ‰€æœ‰æœåŠ¡**
   ```bash
   chmod +x start.sh
   ./start.sh
   ```

   æˆ–è€…æ‰‹åŠ¨å¯åŠ¨ï¼š
   ```bash
   docker-compose up -d
   ```

4. **è®¿é—®åº”ç”¨**
   - å‰ç«¯åº”ç”¨: http://localhost
   - ç®¡ç†åå°: http://localhost/admin
   - API æ–‡æ¡£: http://localhost:7777/api/v1
   - æ•°æ®åº“ç®¡ç†: http://localhost:8081
   - MinIO æ§åˆ¶å°: http://localhost:9001

## ğŸ“ æ–‡ä»¶ç»“æ„

```
infra/docker/
â”œâ”€â”€ Dockerfile                 # å‰ç«¯æ„å»ºé•œåƒ
â”œâ”€â”€ Dockerfile.api            # åç«¯ API æ„å»ºé•œåƒ
â”œâ”€â”€ docker-compose.yaml       # Docker Compose é…ç½®
â”œâ”€â”€ nginx.conf                # Nginx ä¸»é…ç½®
â”œâ”€â”€ default.conf              # Nginx ç«™ç‚¹é…ç½®
â”œâ”€â”€ nginx-proxy.conf          # Nginx åå‘ä»£ç†é…ç½®
â”œâ”€â”€ nginx-default.conf        # Nginx åå‘ä»£ç†ç«™ç‚¹é…ç½®
â”œâ”€â”€ init-db.sql              # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ start.sh                 # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ .env.example             # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

## ğŸ”§ æœåŠ¡é…ç½®

### å‰ç«¯åº”ç”¨ (Web)
- **ç«¯å£**: 80 (HTTP), 443 (HTTPS)
- **æ„å»º**: å¤šé˜¶æ®µæ„å»ºï¼Œæœ€ç»ˆä½¿ç”¨ Nginx æœåŠ¡
- **ç‰¹æ€§**: æ”¯æŒ React Router çš„ SPA åº”ç”¨

### åç«¯ API
- **ç«¯å£**: 7777
- **è¿è¡Œæ—¶**: Node.js 18 Alpine
- **ç‰¹æ€§**: å¥åº·æ£€æŸ¥ã€ç”¨æˆ·éš”ç¦»ã€è‡ªåŠ¨é‡å¯

### æ•°æ®åº“ (PostgreSQL)
- **ç«¯å£**: 5432
- **ç‰ˆæœ¬**: 15 Alpine
- **ç‰¹æ€§**: æ•°æ®æŒä¹…åŒ–ã€å¥åº·æ£€æŸ¥ã€åˆå§‹åŒ–è„šæœ¬

### ç¼“å­˜ (Redis)
- **ç«¯å£**: 6379
- **ç‰ˆæœ¬**: 7 Alpine
- **ç‰¹æ€§**: å¯†ç ä¿æŠ¤ã€æ•°æ®æŒä¹…åŒ–ã€å¥åº·æ£€æŸ¥

### å¯¹è±¡å­˜å‚¨ (MinIO)
- **ç«¯å£**: 9000 (API), 9001 (æ§åˆ¶å°)
- **ç‰¹æ€§**: S3 å…¼å®¹ã€Web æ§åˆ¶å°ã€æ•°æ®æŒä¹…åŒ–

### åå‘ä»£ç† (Nginx)
- **ç«¯å£**: 8080 (HTTP), 8443 (HTTPS)
- **ç‰¹æ€§**: è´Ÿè½½å‡è¡¡ã€SSL ç»ˆæ­¢ã€é™æµä¿æŠ¤

## ğŸ”’ å®‰å…¨é…ç½®

### ç½‘ç»œå®‰å…¨
- å®¹å™¨é—´ç½‘ç»œéš”ç¦»
- è‡ªå®šä¹‰ç½‘ç»œé…ç½®
- ç«¯å£æ˜ å°„é™åˆ¶

### åº”ç”¨å®‰å…¨
- JWT è®¤è¯
- è¯·æ±‚é™æµ
- å®‰å…¨å¤´è®¾ç½®
- CORS é…ç½®

### æ•°æ®å®‰å…¨
- æ•°æ®åº“å¯†ç ä¿æŠ¤
- Redis å¯†ç è®¤è¯
- æ–‡ä»¶æƒé™æ§åˆ¶

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å¥åº·æ£€æŸ¥
- æ‰€æœ‰æœåŠ¡éƒ½é…ç½®äº†å¥åº·æ£€æŸ¥
- è‡ªåŠ¨é‡å¯å¤±è´¥çš„æœåŠ¡
- å¥åº·çŠ¶æ€ç›‘æ§

### æ—¥å¿—ç®¡ç†
- ç»“æ„åŒ–æ—¥å¿—æ ¼å¼
- æ—¥å¿—è½®è½¬é…ç½®
- é”™è¯¯æ—¥å¿—åˆ†ç¦»

### æ€§èƒ½ç›‘æ§
- è¯·æ±‚é™æµé…ç½®
- è¿æ¥æ± ç®¡ç†
- ç¼“å­˜ç­–ç•¥

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### æœåŠ¡ç®¡ç†
```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# åœæ­¢æœåŠ¡
docker-compose down

# é‡å¯æœåŠ¡
docker-compose restart

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f [service_name]
```

### æ•°æ®åº“æ“ä½œ
```bash
# è¿›å…¥æ•°æ®åº“
docker-compose exec postgres psql -U whispers_user -d whispers_db

# è¿è¡Œè¿ç§»
docker-compose exec api npx prisma migrate deploy

# ç”Ÿæˆå®¢æˆ·ç«¯
docker-compose exec api npx prisma generate

# é‡ç½®æ•°æ®åº“
docker-compose exec api npx prisma db push --force-reset
```

### ç»´æŠ¤æ“ä½œ
```bash
# æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
docker system prune -a

# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
docker stats

# å¤‡ä»½æ•°æ®åº“
docker-compose exec postgres pg_dump -U whispers_user whispers_db > backup.sql

# æ¢å¤æ•°æ®åº“
docker-compose exec -T postgres psql -U whispers_user -d whispers_db < backup.sql
```

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ç«¯å£æ˜ å°„
ç¼–è¾‘ `docker-compose.yaml` æ–‡ä»¶ä¸­çš„ `ports` éƒ¨åˆ†ï¼š

```yaml
services:
  web:
    ports:
      - "7777:80"  # å°†å‰ç«¯ç«¯å£æ”¹ä¸º 7777
```

### æ·»åŠ ç¯å¢ƒå˜é‡
åœ¨ `docker-compose.yaml` çš„ `environment` éƒ¨åˆ†æ·»åŠ ï¼š

```yaml
services:
  api:
    environment:
      - CUSTOM_VAR=value
```

### ä¿®æ”¹ Nginx é…ç½®
ç¼–è¾‘ç›¸åº”çš„ Nginx é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯æœåŠ¡ï¼š

```bash
docker-compose restart web nginx
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tulpn | grep :80
   
   # ä¿®æ”¹ docker-compose.yaml ä¸­çš„ç«¯å£æ˜ å°„
   ```

2. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   docker-compose logs [service_name]
   
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   docker-compose ps
   ```

3. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
   docker-compose exec postgres pg_isready -U whispers_user
   
   # æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
   docker-compose logs postgres
   ```

4. **å†…å­˜ä¸è¶³**
   ```bash
   # å¢åŠ  Docker å†…å­˜é™åˆ¶
   # æˆ–åœ¨ docker-compose.yaml ä¸­æ·»åŠ å†…å­˜é™åˆ¶
   services:
     api:
       deploy:
         resources:
           limits:
             memory: 1G
   ```

### æ€§èƒ½ä¼˜åŒ–

1. **å¯ç”¨ Docker BuildKit**
   ```bash
   export DOCKER_BUILDKIT=1
   docker-compose build
   ```

2. **ä½¿ç”¨å¤šé˜¶æ®µæ„å»º**
   - å‰ç«¯å’Œåç«¯éƒ½ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
   - å‡å°‘æœ€ç»ˆé•œåƒå¤§å°

3. **é…ç½®ç¼“å­˜ç­–ç•¥**
   - é™æ€èµ„æºé•¿æœŸç¼“å­˜
   - API å“åº”é€‚å½“ç¼“å­˜

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Nginx é…ç½®æŒ‡å—](https://nginx.org/en/docs/)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)
- [Redis æ–‡æ¡£](https://redis.io/documentation)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ª Docker é…ç½®ï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
