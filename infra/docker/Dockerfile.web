# Web 前端 Dockerfile
FROM node:22-alpine AS base
WORKDIR /app

# 安装 pnpm（使用 corepack 更快）
RUN corepack enable && corepack prepare pnpm@latest --activate

# 开发阶段
FROM base AS development
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/web/package.json ./apps/web/
COPY packages/ui/package.json ./packages/ui/
COPY packages/hooks/package.json ./packages/hooks/
COPY packages/types/package.json ./packages/types/
COPY packages/utils/package.json ./packages/utils/
RUN pnpm install --frozen-lockfile

COPY . .
EXPOSE 8888
CMD ["pnpm", "dev:web"]

# 构建阶段
FROM base AS build
ARG VITE_API_URL=http://localhost:7777

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/web/package.json ./apps/web/
COPY packages/ui/package.json ./packages/ui/
COPY packages/hooks/package.json ./packages/hooks/
COPY packages/types/package.json ./packages/types/
COPY packages/utils/package.json ./packages/utils/
RUN pnpm install --frozen-lockfile

COPY . .

# 设置环境变量
ENV VITE_API_URL=${VITE_API_URL}

# 并行构建依赖的 packages（使用 turbo 自动处理依赖关系）
RUN pnpm turbo run build --filter=@whispers/types --filter=@whispers/utils --filter=@whispers/hooks --filter=@whispers/ui --concurrency=4 || true

# 构建 Web 应用
RUN pnpm build:web

# 验证构建产物存在
RUN ls -la apps/web/dist/ && test -f apps/web/dist/index.html

# 生产阶段 - 只输出构建产物，由外部 nginx 服务静态文件
FROM alpine:latest AS production

# 创建目标目录
RUN mkdir -p /dist

# 复制构建产物到临时目录
COPY --from=build /app/apps/web/dist /app/dist

# 启动时将文件复制到卷挂载点，然后退出
# 使用 cp -r 确保每次都更新文件
CMD ["sh", "-c", "rm -rf /dist/* && cp -r /app/dist/* /dist/ && echo 'Build artifacts copied to /dist' && ls -la /dist/"]
